# UnB RAG - Sistema de Recupera√ß√£o H√≠brida (MCP + Crawler)

Este reposit√≥rio cont√©m uma implementa√ß√£o avan√ßada de RAG (Retrieval-Augmented Generation) projetada para documentos acad√™micos e administrativos da Universidade de Bras√≠lia (UnB).

O sistema utiliza uma arquitetura de **Busca H√≠brida (Hybrid Search)** combinando busca sem√¢ntica (Embeddings) e busca lexical (BM25/TF-IDF) via PostgreSQL, orquestrada por um servidor **MCP (Model Context Protocol)**.

-----

## üöÄ Funcionalidades Principais

  * **Busca H√≠brida com RRF:** Utiliza *Reciprocal Rank Fusion* para combinar a precis√£o de palavras-chave exatas (`tsvector`) com a compreens√£o de contexto (`vector cosine similarity`).
  * **Enriquecimento Inteligente (Gemini 2.5):** Antes de indexar, cada fragmento de texto √© analisado pelo Google Gemini para gerar metadados e palavras-chave contextuais, melhorando a recuperabilidade.
  * **Crawler Focado:** Sistema automatizado que varre URLs semente (ex: p√°ginas de matr√≠cula) e extrai conte√∫do recursivamente.
  * **Ingest√£o de M√∫ltiplos Formatos:** Suporte nativo para **PDFs** locais e p√°ginas **Web** (incluindo renderiza√ß√£o din√¢mica via Playwright).
  * **Arquitetura MCP:** O servidor exp√µe ferramentas padronizadas para conex√£o direta com Agentes de IA (Claude Desktop, IDEs com suporte a MCP, etc).

-----

## üõ†Ô∏è Pr√©-requisitos (Ubuntu 22.04)

### 1\. Sistema e Depend√™ncias

Certifique-se de ter o Python 3.10+ e bibliotecas de constru√ß√£o instaladas:

```bash
sudo apt update && sudo apt install -y python3-pip python3-venv build-essential libpq-dev
```

### 2\. Banco de Dados (PostgreSQL + pgvector)

O projeto requer o PostgreSQL com a extens√£o `pgvector`. A forma mais recomendada de rodar √© via Docker para garantir compatibilidade das vers√µes:

```bash
# Se n√£o tiver docker instalado:
# sudo apt install docker.io

# Subir container do Postgres com pgvector
sudo docker run -d \
  --name unb_rag_db \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=postgres \
  -e POSTGRES_DB=unb_rag_db \
  -p 5432:5432 \
  pgvector/pgvector:pg16
```

-----

## üì¶ Instala√ß√£o

1.  **Clone o reposit√≥rio:**

    ```bash
    git clone https://github.com/seu-usuario/unb-rag.git
    cd unb-rag
    ```

2.  **Crie e ative o ambiente virtual:**

    ```bash
    python3 -m venv venv
    source venv/bin/activate
    ```

3.  **Instale as depend√™ncias:**

    ```bash
    pip install -r requirements.txt
    ```

4.  **Instale os navegadores do Playwright (Necess√°rio para o Crawler):**

    ```bash
    playwright install chromium
    ```

-----

## ‚öôÔ∏è Configura√ß√£o

Crie um arquivo `.env` na raiz do projeto com base no exemplo abaixo:

```ini
# .env

# Chave API do Google (Necess√°ria para o enriquecimento de dados na ingest√£o)
GEMINI_API_KEY="sua_chave_api_do_google_ai_studio"

# Configura√ß√µes do Banco de Dados
DB_USER="postgres"
DB_PASS="postgres"
DB_HOST="localhost"
DB_PORT="5432"
DB_NAME="unb_rag_db"

# Logs
LOG_LEVEL="INFO"
```

> **Nota:** Se estiver usando Docker, as credenciais acima j√° funcionam por padr√£o.

-----

## üñ•Ô∏è Uso: Pipeline de Ingest√£o (Escrita)

O m√≥dulo de ingest√£o √© respons√°vel por ler PDFs locais e URLs, enriquecer o conte√∫do via Gemini e salvar no banco com vetores h√≠bridos.

### Adicionar Arquivos Locais

Coloque seus arquivos `.pdf`, `.txt` ou `.md` na pasta:
`unb_rag/documentos_locais/`

### Rodar a Ingest√£o

Para iniciar o crawler e processar arquivos locais:

```bash
# Executar como m√≥dulo a partir da raiz
python3 -m src.ingestor.main
```

**Op√ß√µes:**

  * `--substitute`: **CUIDADO**. Limpa todo o banco de dados (DROP TABLE) antes de iniciar a ingest√£o. Use para reiniciar o ambiente.
    ```bash
    python3 -m src.ingestor.main --substitute
    ```

-----

## üåê Uso: Servidor MCP (Leitura)

O servidor disponibiliza a ferramenta `enriquecer_prompt_com_rag_unb` via protocolo HTTP/MCP.

### Iniciar o Servidor

```bash
python3 -m src.server.main
```

*O servidor iniciar√° em `http://0.0.0.0:8888`.*

### Testar a Recupera√ß√£o

Em outro terminal, execute o cliente de teste para verificar se a busca h√≠brida est√° retornando contextos relevantes:

```bash
python3 src/server/test_client.py
```

-----

## üß© Arquitetura do Projeto

O projeto segue uma estrutura de Monorepo modular:

```text
unb_rag/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ common/      # Configura√ß√µes e Conex√£o DB (Singleton)
‚îÇ   ‚îú‚îÄ‚îÄ ingestor/    # ETL: Crawler -> Gemini -> Vector DB
‚îÇ   ‚îî‚îÄ‚îÄ server/      # API: MCP -> Hybrid Search -> JSON
‚îú‚îÄ‚îÄ documentos_locais/
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ .env
```

### Fluxo de Dados (Hybrid Search)

1.  **Usu√°rio** envia query: *"Qual o prazo para matr√≠cula?"*
2.  **Embeddings:** O sistema converte a pergunta em vetor (SentenceTransformer).
3.  **Busca Vetorial:** Encontra documentos semanticamente pr√≥ximos.
4.  **Busca Textual (`tsvector`):** Encontra documentos com palavras-chave exatas ("prazo", "matr√≠cula").
5.  **RRF (Reciprocal Rank Fusion):** Um algoritmo de rankeamento combina as duas listas, priorizando documentos que aparecem em ambas.
6.  **Retorno:** O servidor entrega os top-K chunks mais relevantes.

-----

## üêõ Solu√ß√£o de Problemas Comuns

**Erro: `operator does not exist: vector <=> numeric[]`**

  * **Causa:** O banco n√£o est√° convertendo a lista Python para vetor SQL.
  * **Solu√ß√£o:** O c√≥digo j√° implementa o cast `::vector`, mas certifique-se de que a extens√£o foi ativada (`register_vector(conn)` no c√≥digo Python cuida disso).

**Erro: `playwright._impl._api_types.Error: Executable doesn't exist`**

  * **Solu√ß√£o:** Voc√™ esqueceu de rodar `playwright install chromium`.

**Gemini API Error (400/403)**

  * **Causa:** Chave de API inv√°lida ou cota excedida.
  * **Solu√ß√£o:** Verifique a `GEMINI_API_KEY` no `.env`. O ingestor falhar√° silenciosamente no enriquecimento (logs warning), mas continuar√° a ingest√£o b√°sica.
